---
title: "隠線処理の話"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [Python, 数学, math]
published: false
---

## 概要

こんな感じに3次元の立体を2次元に描画するときに線が隠れるようにする処理の話です。

![rotate.gif](/images/hidden_line_normal/rotate.gif)

Pythonによるサンプルコードは以下にあります。

[https://github.com/kaityo256/hidden-line](https://github.com/kaityo256/hidden-line)

そのままGoogle Colabで試すことができるサンプルもあります。

## はじめに

3次元の物体を2次元に射影することを考えます。例えば立方体を描画するとこんな感じになります。

![fig1](/images/hidden_line_normal/fig1.png)

ここでは立方体の辺が針金でできているかのように全て見えていますが、もしこの物体の中身が詰まっていて不透明なら以下のように見えるでしょう。

![fig2](/images/hidden_line_normal/fig2.png)

先ほどの場合と比較して、三本の線が消えました。このように「こういう状況なら見えないはず」という条件を計算し、見えない部分を描かないようにするのが隠線処理です。

隠線処理にはいろいろなアルゴリズムがあります。簡単なのは、奥から面を描画していき、上書きしていく方法です。これを塗り重ね法と呼びます。この方法は簡単ですが、この立方体の内部にさらに物体があったりする場合に対応できません。

今回、分子動力学シミュレーションの実行結果の可視化に使いたい、というニーズがあり、「空間にあるワイヤーフレーム状の直方体の中に多数の球がある」という状態を描画する必要がありました。例えば、立方体の中に一つだけ大きな球があるとこんな感じになります。

![fig3](/images/hidden_line_normal/fig3.png)

このような描画を行うためには、

1. 球の後ろにある線を描画する
  ![fig4a](/images/hidden_line_normal/fig4a.png)
2. その上に球を描画する
  ![fig4b](/images/hidden_line_normal/fig4b.png)
3. さらにその上に残りの線を描画する
  ![fig3](/images/hidden_line_normal/fig3.png)

みたいなことをする必要があります。要するに、空間に浮いている立方体(直方体)の辺のうち、視線から見て後ろ側にあるか、前側にあるかを判定する必要があるということです。

このように、与えられた立体の辺のうち、どの辺が「向こう側」にあり、どの辺が「こちら側」にあるかを判定するアルゴリズムが法線ベクトル法です。法線ベクトル法は、凸多面体にしか使えませんが、アルゴリズムが単純なので、今回はこれを採用しました。

## 法線ベクトル法の原理

簡単のために2次元で考えましょう。いま、左から右を見ていて、その方向に正方形があるとします(長方形でも話は同じです)。

![normal1](/images/hidden_line_normal/normal1.png)

もし立方体が不透明なら、ユーザから青い点は見えますが、赤い点は見えません。なので、青い点が「こちら側」、赤い点が「向こう側」です。このように、点がどちら側に属すのかを判定しましょう、というのが法線ベクトル法です。そのために、まず辺がどちら側にあるかを考えます。

![normal2](/images/hidden_line_normal/normal2.png)

もし立方体が不透明である時、ユーザから見える辺を青、見えない辺を赤で塗ったのが上の図です。これを見ると、点につながる辺が2つとも見えない場合にのみ、その点が見えず、それ以外の点は見える、ということがわかります。したがって、辺が「こちら側」を向いているか、「向こう側」を向いているかを判定すれば良いことになります。

![normal3](/images/hidden_line_normal/normal3.png)

そのためには、各辺に物体の中心から遠ざかる向きの法線ベクトルを考え、視線ベクトルと同じ向きであるかどうか判定すればよいことになります。つまり、各辺の法線ベクトルと視線ベクトルの内積をとり、内積が負なら逆向き、すなわちその面は「こちら向き」であり、内積が正ならその面は「向こう向き」であることになります。

以上の理屈は3次元であっても全く同じです。いま、複数の面からなる凸多面体がある時、以下のようにして辺がこちら側にあるか、奥側にあるかを判定できます。

1. 各面の法線ベクトル(方向を多面体から外側にとります)について、視線ベクトルと内積をとり、その正負によって、面が「こちら向き」であるか「向こう向き」であるかを判定します。
2. 各辺について、その辺に接する面の向きを調べます。もし2つの面ともに「向こう向き」であれば、線は見えません。それ以外は見えると判定できます。

## 具体的な実装

さて、法線ベクトル法のコンセプトは簡単なのですが、実装はわりと面倒です。もともとの目的が分子動力学シミュレーションの可視化なので、以後、描画する直方体のことをシミュレーションボックスと呼びます。

最初に、シミュレーションボックスをx, y, z軸にそろえておきます。すなわち、$x_\mathrm{min} < x < x_\mathrm{max}, y_\mathrm{min} < y < y_\mathrm{max},z_\mathrm{min} < z < z_\mathrm{max}$を満たすような領域をシミュレーションボックスと定義します。

この世界を、3次元回転行列$R$によって回転させた結果、どの辺が見えなくなるかを判定するコードを考えます。そのために、まずはシミュレーションボックスを構成する頂点、面、辺に番号をつけましょう。

まずは頂点に番号をつけます。頂点は8個ありますが、以下のように2進数的なノリで番号付けすると良いでしょう。

![index1.png](/images/hidden_line_normal/index1.png)

| 頂点番号 | 座標 |
| ---- | ---- |
| 0 | $(x_\mathrm{min}, y_\mathrm{min}, z_\mathrm{min})$ |
| 1 | $(x_\mathrm{max}, y_\mathrm{min}, z_\mathrm{min})$ |
| 2 | $(x_\mathrm{min}, y_\mathrm{max}, z_\mathrm{min})$ |
| 3 | $(x_\mathrm{max}, y_\mathrm{max}, z_\mathrm{min})$ |
| 4 | $(x_\mathrm{min}, y_\mathrm{min}, z_\mathrm{max})$ |
| 5 | $(x_\mathrm{max}, y_\mathrm{min}, z_\mathrm{max})$ |
| 6 | $(x_\mathrm{min}, y_\mathrm{max}, z_\mathrm{max})$ |
| 7 | $(x_\mathrm{max}, y_\mathrm{min}, z_\mathrm{max})$ |

次に、面に番号をつけましょう。まず、$x = x_\mathrm{min}$であるような面を0として、対面する面はインデックスが3だけずれるようにしましょう。

![index2.png](/images/hidden_line_normal/index2.png)

| 面番号 | 座標 | 
| ---- | ---- |
| 0 | $x = x_\mathrm{min}$|
| 1 | $y = y_\mathrm{min}$|
| 2 | $z = z_\mathrm{min}$|
| 3 | $x = x_\mathrm{max}$|
| 4 | $y = y_\mathrm{max}$|
| 5 | $z = z_\mathrm{max}$|

最後に、辺に番号をつけます。先ほど定義した点を2つ組み合わせることで辺を表現しましょう。例えば、辺番号0番は$(x_\mathrm{min}, y_\mathrm{min}, z_\mathrm{min})$から$(x_\mathrm{max}, y_\mathrm{min}, z_\mathrm{min})$までの線分とします。これは0番の点と1番の点なので$(0, 1)$と表現します。同様に他の辺も定義していきます。

| 辺番号 | 点の組み合わせ | 
| ---- | ---- |
| 0    | $ (0, 1) $ | 
| 1    | $ (2, 3) $ | 
| 2    | $ (4, 5) $ | 
| 3    | $ (6, 7) $ | 
| 4    | $ (0, 2) $ | 
| 5    | $ (1, 3) $ | 
| 6    | $ (4, 6) $ | 
| 7    | $ (5, 7) $ | 
| 8    | $ (0, 4) $ | 
| 9    | $ (1, 5) $ | 
| 10   | $ (2, 6) $ | 
| 11   | $ (3, 7) $ | 

